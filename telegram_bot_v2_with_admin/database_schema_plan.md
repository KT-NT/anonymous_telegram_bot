# План обновления схемы базы данных для админ-панели и VIP-статуса

## Анализ текущей структуры

### Существующие таблицы:
1. **TelegramUser** - основная информация о пользователях
2. **AnonymousMessage** - анонимные сообщения

## Требуемые изменения для админ-панели и VIP-функций

### 1. Обновление таблицы TelegramUser

Добавить поля:
- `is_vip` (Boolean) - VIP-статус пользователя
- `is_admin` (Boolean) - статус администратора
- `vip_granted_at` (DateTime) - дата выдачи VIP-статуса
- `vip_granted_by` (Integer, FK) - кто выдал VIP-статус (ссылка на админа)

### 2. Новая таблица AdminSession

Для управления сессиями администраторов:
- `id` (Integer, PK) - уникальный идентификатор
- `admin_id` (Integer, FK) - ссылка на TelegramUser с is_admin=True
- `session_token` (String) - токен сессии
- `created_at` (DateTime) - время создания сессии
- `expires_at` (DateTime) - время истечения сессии
- `is_active` (Boolean) - активность сессии

### 3. Обновление таблицы AnonymousMessage

Добавить поля:
- `sender_name` (String, nullable) - имя отправителя (для VIP-пользователей)
- `sender_contact` (String, nullable) - контакт отправителя (для VIP-пользователей)
- `is_anonymous` (Boolean, default=True) - флаг анонимности сообщения

### 4. Новая таблица AdminAction

Для логирования действий администраторов:
- `id` (Integer, PK) - уникальный идентификатор
- `admin_id` (Integer, FK) - кто выполнил действие
- `action_type` (String) - тип действия (grant_vip, revoke_vip, view_messages, etc.)
- `target_user_id` (Integer, FK, nullable) - на кого направлено действие
- `description` (Text) - описание действия
- `created_at` (DateTime) - время выполнения действия

### 5. Новая таблица VIPMessageSettings

Настройки для VIP-пользователей:
- `id` (Integer, PK) - уникальный идентификатор
- `user_id` (Integer, FK) - ссылка на TelegramUser
- `allow_non_anonymous` (Boolean, default=True) - разрешить неанонимные сообщения
- `require_contact` (Boolean, default=False) - требовать контактную информацию
- `custom_message` (Text, nullable) - кастомное сообщение для формы

## Функциональные требования

### Для администраторов:
1. **Аутентификация**:
   - Вход через специальную команду в Telegram боте
   - Генерация временного токена доступа
   - Проверка прав доступа

2. **Управление пользователями**:
   - Просмотр списка всех пользователей
   - Поиск пользователей по имени/username
   - Выдача/отзыв VIP-статуса
   - Просмотр статистики пользователя

3. **Просмотр сообщений**:
   - Просмотр всех сообщений в системе
   - Фильтрация по пользователям
   - Просмотр неанонимных сообщений VIP-пользователей

4. **Логирование**:
   - Все действия администраторов логируются
   - Возможность просмотра истории действий

### Для VIP-пользователей:
1. **Расширенная форма**:
   - Опция "Показать мое имя" при отправке сообщения
   - Поле для контактной информации (опционально)
   - Кастомизированный интерфейс

2. **Уведомления**:
   - Получение информации о том, кто отправил сообщение (если не анонимно)
   - Специальное форматирование сообщений в Telegram

## Безопасность

### Контроль доступа:
1. **Администраторы**:
   - Жестко заданный список Telegram ID в конфигурации
   - Временные сессии с автоматическим истечением
   - Двухфакторная аутентификация через Telegram

2. **VIP-пользователи**:
   - Статус выдается только администраторами
   - Возможность отзыва статуса
   - Логирование всех изменений статуса

### Защита данных:
1. **Шифрование**:
   - Токены сессий хешируются
   - Чувствительные данные не хранятся в открытом виде

2. **Аудит**:
   - Полное логирование действий администраторов
   - Возможность отслеживания изменений

## Миграция данных

### Этапы миграции:
1. **Создание новых таблиц**
2. **Добавление новых полей в существующие таблицы**
3. **Установка значений по умолчанию**
4. **Создание индексов для производительности**

### Обратная совместимость:
- Все существующие функции продолжают работать
- Новые поля имеют значения по умолчанию
- Постепенное внедрение новых возможностей

## Интерфейс админ-панели

### Структура страниц:
1. **Главная страница** - общая статистика
2. **Пользователи** - управление пользователями и VIP-статусом
3. **Сообщения** - просмотр всех сообщений
4. **Логи** - история действий администраторов
5. **Настройки** - конфигурация системы

### Технологии:
- Backend: Flask с расширениями для аутентификации
- Frontend: HTML/CSS/JavaScript с Bootstrap для адаптивности
- AJAX для динамического обновления данных

